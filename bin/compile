#!/usr/bin/env bash

set -e

buildpack_dir=$(dirname $(dirname $(readlink -e $0)))
build_dir="$1"
cache_dir="$2"
env_dir="$3"

mkdir -p $cache_dir

function lazyDownloadAndUnpack() {
    url="$1"
    dest="$2"
    target=$(basename "$url")
    cached="$cache_dir/$target"
    cached_unpacked="$cache_dir/$target-unpacked"
    echo "Processing $target"
    if [ ! -f "$cached" ]; then
        echo "Downloading $target"
        curl -L --silent "$url" -o "$cached"
    else
        echo "$target already present, skipping"
    fi

    if [ ! -z "$dest" -a ! -d "$cached_unpacked" ]; then
        unpacked=0
        echo "Unpacking $target to cache"
        echo "$target" | grep '\.deb$' && dpkg-deb -x "$cached" "$cached_unpacked" && unpacked=1
        echo "$target" | grep '^mendix-.*\.tar\.gz$' && mkdir $cached_unpacked && tar xf "$cached" -C "$cached_unpacked" && unpacked=1

        if [ $unpacked == 1 ]; then
            rm -r $cached && touch $cached
        fi
    fi

    if [ ! -z "$dest" ]; then
        echo "Copying $cached_unpacked to $dest"
        cp -a $cached_unpacked/. $dest
    fi
    echo "Done processing $target"
}

function checkpoint() {
    msg="$1"
    echo "==> $msg"
}

PRE_FLIGHT_CHECK=yes

if [[ -z "$ADMIN_PASSWORD" && ! -f "$env_dir/ADMIN_PASSWORD" ]]; then
    echo "You should provide an ADMIN_PASSWORD environment variable"
    PRE_FLIGHT_CHECK=no
fi

if [[ -n "$DATABASE_URL" ]]; then
    echo "Database service detected"
else
    echo "You should add a database service to this application, and it should be postgres"
    PRE_FLIGHT_CHECK=no
fi

if [[ "$PRE_FLIGHT_CHECK" == "no" ]]; then
    exit 1
fi

RUNTIME_VERSION=$(cat "$build_dir/model/metadata.json" | grep RuntimeVersion | awk '{ print $2 }' | sed 's/\"//g; s/,//g; s/\n//g; s/\r//g')

# we set the homedir to the build_dir, so pip will install to $build_dir/.local
export HOME="$build_dir"

lazyDownloadAndUnpack "https://download.mendix.com/get-pip.py"
python "$cache_dir/get-pip.py" --user

mkdir -p "$cache_dir/pip"

# DIRT: we need to download a custom version of PyYAML that does not try to compile libyaml
checkpoint "begin install pyyaml"
~/.local/bin/pip install --download-cache "$cache_dir/pip" --user http://download.mendix.com/PyYAML-3.11.tar.gz http://download.mendix.com/m2ee-tools-0.5.9.tar.gz
checkpoint "end install pyyaml"

lazyDownloadAndUnpack "https://packages.mendix.com/debian/pool/non-free/o/oracle-j2re1.7/oracle-j2re1.7_1.7.0+update55_amd64.deb" "$build_dir/.local/"

ln -s "../usr/lib/jvm/j2re1.7-oracle/bin/java" "$build_dir/.local/bin/java"

# DIRT: the script contains import m2ee, so we need to make sure it imports the package, not m2ee.py
mv "$build_dir/.local/bin/m2ee.py" "$build_dir/.local/bin/m2ee"

mkdir -p $build_dir/{runtimes,log}
mkdir -p $build_dir/database
mkdir -p $build_dir/data/{files,tmp}
lazyDownloadAndUnpack "https://download.mendix.com/runtimes/mendix-${RUNTIME_VERSION}.tar.gz" "$build_dir/runtimes/"

cp "$buildpack_dir/m2ee.yaml" "$build_dir/m2ee-building.yaml"

sed -i "s|BUILD_PATH|$build_dir|g" "$build_dir/m2ee-building.yaml"

rm "$build_dir/m2ee-building.yaml"

cp "$buildpack_dir/m2ee.yaml" "$build_dir/.local/m2ee.yaml"
cp "$buildpack_dir/start.py" "$build_dir/start.py"
